<?xml version="1.0" encoding="utf-8"?>
<Project>
  <!--
    BetterVanilla.Ui XAML-like Generation System
    MSBuild targets for generating C# code from .bvui.xml files.
  -->

  <PropertyGroup>
    <BvuiGeneratorProject>$(MSBuildThisFileDirectory)..\Tools\BetterVanilla.Ui.XamlGenerator\BetterVanilla.Ui.XamlGenerator.csproj</BvuiGeneratorProject>
  </PropertyGroup>

  <!--
    Target: GenerateBvuiCode
    Generates C# code from .bvui.xml files before compilation.
  -->
  <Target Name="GenerateBvuiCode"
          BeforeTargets="CoreCompile"
          Condition="'$(EnableBvuiGeneration)' == 'true' AND '@(BvuiFile)' != ''">

    <!-- Ensure output directory exists -->
    <MakeDir Directories="$(BvuiGeneratedOutputPath)" />

    <!-- Log what we're doing -->
    <Message Text="BetterVanilla.Ui: Generating code from @(BvuiFile->Count()) BVUI file(s)..."
             Importance="high" />

    <!-- Run the generator using dotnet run -->
    <Exec Command="dotnet run --project &quot;$(BvuiGeneratorProject)&quot; --no-build -- &quot;%(BvuiFile.FullPath)&quot; &quot;$(BvuiGeneratedOutputPath)&quot; --aliases &quot;$(BvuiAliasesFile)&quot; $(BvuiVerboseArg)"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          IgnoreExitCode="false" />

    <!-- Log completion -->
    <Message Text="BetterVanilla.Ui: Code generation complete."
             Importance="normal" />
  </Target>

  <!-- Set verbose argument -->
  <PropertyGroup>
    <BvuiVerboseArg Condition="'$(BvuiVerbose)' == 'true'">--verbose</BvuiVerboseArg>
  </PropertyGroup>

  <!--
    Target: CollectBvuiGeneratedFiles
    Collects generated .g.cs files for compilation.
  -->
  <Target Name="CollectBvuiGeneratedFiles"
          AfterTargets="GenerateBvuiCode"
          BeforeTargets="CoreCompile"
          Condition="'$(EnableBvuiGeneration)' == 'true'">

    <!-- Find all generated .g.cs files from our output path -->
    <ItemGroup>
      <BvuiGeneratedFile Include="$(BvuiGeneratedOutputPath)\**\*.g.cs" />
    </ItemGroup>

    <!-- Add to compilation -->
    <ItemGroup>
      <Compile Include="@(BvuiGeneratedFile)" Condition="'@(BvuiGeneratedFile)' != ''">
        <AutoGen>true</AutoGen>
        <DependentUpon>%(Filename).bvui.xml</DependentUpon>
      </Compile>
    </ItemGroup>

    <Message Text="BetterVanilla.Ui: Added @(BvuiGeneratedFile->Count()) generated file(s) to compilation from $(BvuiGeneratedOutputPath)"
             Importance="high"
             Condition="'@(BvuiGeneratedFile)' != ''" />
  </Target>

  <!--
    Target: CleanBvuiGenerated
    Cleans generated files.
  -->
  <Target Name="CleanBvuiGenerated"
          AfterTargets="Clean"
          Condition="'$(EnableBvuiGeneration)' == 'true'">

    <RemoveDir Directories="$(BvuiGeneratedOutputPath)" />
    <Message Text="BetterVanilla.Ui: Cleaned generated files."
             Importance="normal" />
  </Target>

  <!--
    Target: BuildBvuiGenerator
    Ensures the generator is built before use.
  -->
  <Target Name="BuildBvuiGenerator"
          BeforeTargets="GenerateBvuiCode"
          Condition="'$(EnableBvuiGeneration)' == 'true' AND '@(BvuiFile)' != ''">

    <MSBuild Projects="$(BvuiGeneratorProject)"
             Targets="Build"
             Properties="Configuration=$(Configuration)" />
  </Target>

</Project>
